{% set inverseClass = block.position == 'left' ? '' : 'flex-row-reverse' %}

{% apply enkode_emails %}
    <div class="flex flex-wrap -mx-4 {{ inverseClass }}">
        <div class="w-full px-4 md:w-1/2">
            {% if block.video|length %}
            {% set consent = craft.app.request.rawCookies.value('__cookie_consent') %}

            {% set embed = craft.videoparser.parse(block.video) %}
            {% if embed %}
                <figure class="block">
                    <div class="relative bg-center bg-cover bg-black/50 bg-blend-multiply before:aspect-video before:block before:w-full js-bg-target" id="video-{{block.id}}">
                        {% set image = block.placeholderImage.collect().first() %}
                        {% if image %}
                            {% set optimizedImage = image.optimizedTextImage %}
                            <picture>
                                {% if craft.imageOptimize.serverSupportsWebP() and image.extension != 'svg' and image.extension != 'gif' %}
                                    <source srcset="{{ optimizedImage.srcsetWebP() }}"
                                            sizes="(max-width: 479px) 100vw, (min-width: 480px) and (max-width: 659px) 448px, (min-width: 660px) and (max-width: 819px) 628px, (min-width: 820px) and (max-width: 979px) 378px, (min-width: 980px) and (max-width: 1199px) 458px, (min-width: 1200px) 568px"
                                            type="image/webp"/>
                                {% endif %}
                                <img src="{{ optimizedImage.placeholderBox() }}"
                                     srcset="{{ optimizedImage.srcset() }}"
                                     sizes="(max-width: 479px) 100vw, (min-width: 480px) and (max-width: 659px) 448px, (min-width: 660px) and (max-width: 819px) 628px, (min-width: 820px) and (max-width: 979px) 378px, (min-width: 980px) and (max-width: 1199px) 458px, (min-width: 1200px) 568px"
                                     width="{{optimizedImage.placeholderWidth}}" height="{{optimizedImage.placeholderHeight}}"
                                     alt=""
                                     class="js-bg-src" loading="lazy"/>
                            </picture>
                        {% else %}
                            {% if embed.type == 'youtube' %}
                                <img src="https://i.ytimg.com/vi/{{embed.id}}/hqdefault.jpg" alt="" class="js-bg-src" srcset="https://i.ytimg.com/vi/{{embed.id}}/maxresdefault.jpg 1280w, https://i.ytimg.com/vi/{{embed.id}}/sddefault.jpg 640w, https://i.ytimg.com/vi/{{embed.id}}/hqdefault.jpg 480w, https://i.ytimg.com/vi/{{embed.id}}/mqdefault.jpg 320w"
                                     sizes="(max-width: 479px) 100vw, (min-width: 480px) and (max-width: 659px) 448px, (min-width: 660px) and (max-width: 819px) 628px, (min-width: 820px) and (max-width: 979px) 378px, (min-width: 980px) and (max-width: 1199px) 458px, (min-width: 1200px) 568px"/>
                            {% endif %}
                            {% if embed.type == 'vimeo' %}
                                <img src="https://vumbnail.com/{{embed.id}}.jpg" alt="" class="js-bg-src"/>
                            {% endif %}
                        {% endif %}
                        <button type="button" class="absolute inset-0"
                                data-s-video-toggle="{{embed.embedSrc}}"
                                data-s-video-toggle-container="#video-{{block.id}}"
                                data-s-video-toggle-show-close-button="false"
                                {% if consent != "true" and consent != "2" %}disabled{% endif %}>
                            <span class="absolute flex items-center px-4 py-2 text-white -translate-x-1/2 -translate-y-1/2 rounded bg-primary top-1/2 left-1/2">
                                {{ icon('play-arrow', { class: 'mr-2 text-xl' }) }}  {{ 'Play video'|t }}
                            </span>
                        </button>
                        {% if consent != "true" and consent != "2" %}
                            <div class="relative z-10 w-full h-full -mt-[56.25%] lg:mt-0 max-w-full p-6 overflow-auto bg-white border-black lg:absolute border-1 lg:-translate-x-1/2 lg:-translate-y-1/2 lg:top-1/2 lg:left-1/2 lg:w-max lg:h-auto" data-video-consent-blocker>
                                <h2 class="text-xl font-bold">{{ 'Cookie consent required'|t }}</h2>
                                <p class="mt-2">{{ 'This video can only be viewed after accepting cookies'|t }}</p>
                                <div class="flex flex-wrap items-center w-full gap-2 mt-4 md:gap-6">
                                    <button type="button" class=" btn btn--primary js-cookie-settings">{{ 'Accept cookies'|t }}</button>
                                    <a href="{{block.video}}" class="underline hover:no-underline" target="_blank">{{ "Or view this video on "|t}}{{embed.type}}</a>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                    {% if block.videoCaption|length %}
                        <figcaption class="mt-2 text-sm text-editor">
                            {{ block.videoCaption }}
                        </figcaption>
                    {% endif %}
                </figure>
            {% endif %}
        {% endif %}
    </div>
    <div class="w-full px-4 mt-4 md:mt-0 md:w-1/2">
        {% if block.blockTitle|length %}
            <h2 id="{{ block.blockTitle|slugify }}">{{ block.blockTitle }}</h2>
        {% endif %}
        {% if block.text|length %}
            <div class="text-editor">
                {{ block.text | raw }}
            </div>
        {% endif %}
        {% if block.cta|length %}
            <div class="flex flex-wrap items-baseline gap-4 mt-6">
                {{ render_hyper_links(block.cta) | raw }}
            </div>
        {% endif %}
    </div>
</div>
{% endapply %}
