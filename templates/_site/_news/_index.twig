{% extends "_site/_layout" %}

{% set breadcrumbs = [entry] %}

{% block content %}

    {% include "_site/_snippet/_content/_defaultHeader" %}

    {% set entries = craft.entries.section('news').orderBy('postDate DESC') %}
    {% set searchQuery = craft.app.request.getQueryParam('search') %}
    {% set catQuery = craft.app.request.getQueryParam('category') %}

    {% set relationParam = ['and'] %}

    {% if catQuery %}
        {% set relationParam = relationParam|merge([{ targetElement: catQuery }]) %}
    {% endif %}

    {% if relationParam|length > 1 %}
        {% set entries = entries.relatedTo(relationParam) %}
    {% endif %}

    {% if searchQuery %}
        {% set entries = entries.search(searchQuery).orderBy('score') %}
    {% endif %}
    

    {% set totalEntries = entries|length %}
    {% paginate entries.limit(10) as pageInfo, news %}

    <div class="section section--default">
        <div class="container">
            <h2 id="filterExtraInfo">
                {{ totalEntries }} {{ 'resultaten gevonden'|t }}
            </h2>
            <div class="flex flex-wrap -mx-4">
                <div class="w-full px-4 md:w-1/3">
                    <div>
                        <div class="md:hidden">
                            <button type="button" class="w-full flex justify-between" id="filterMobileToggle">
                                {# This element will get the class 'open' when the filter is open #}
                                <span>
                                    {{ 'Filter results'|t }}
                                    <span id="secondExtraInfo">
                                        ({{ totalEntries }} {{ 'resultaten gevonden'|t }})
                                    </span>
                                </span>
                                {{ icon('chevron-down') }}
                            </button>
                        </div>
                        <div id="filterMobileCollapse">
                            <form action=""
                                data-filter="filterResults"
                                data-filter-aria-live="filterAriaLive"
                                data-filter-extra="filterExtraInfo,secondExtraInfo"
                                data-filter-mobile-toggle="filterMobileToggle"
                                data-filter-mobile-collapse="filterMobileCollapse"
                                data-filter-scroll-position="filterScrollPosition"
                                data-filter-loader="filterLoader"
                                data-filter-pagination="filterPagination"
                                data-filter-clear="filterClear,filterClearInResults"
                                data-filter-scroll-on-new-results="true"
                                data-filter-disable-scroll-on-mobile="true"
                                data-filter-mobile-breakpoint="819"
                                data-filter-scroll-speed="500"
                                data-datalayer-event="filter"
                                data-datalayer-ignore="ignore,ignore-me-too">
                                {% set categories = craft.entries.section('newsCategories').level(1) %}
                                {% if categories|length %}
                                    <div>
                                        <h3>{{ "Zoek"|t }}</h3>
                                        <div class="">
                                            <label for="searchFilter" class="sr-only">{{"Zoeken"|t}}</label>
                                            <input type="text" name="search" id="searchFilter" placeholder="{{ 'Zoeken...'|t }}" value="{{ searchQuery ?? '' }}" class="w-full"/>
                                        </div>
                                        <h3>{{ "Categories"|t }}</h3>
                                        <ul>
                                            {% for category in categories %}
                                                <li class="form__custom-checkbox">
                                                    <input type="checkbox" id="{{ category.id }}" name="category[]"
                                                            value="{{ category.id }}" data-datalayer-value="test-{{category.title}}" {% if category.id in catQuery %} checked {% endif %}/>
                                                    <label for="{{ category.id }}">{{ category.title }}</label>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                        <hr>
                                        <ul>
                                            {% for category in categories %}
                                                <li class="form__custom-checkbox">
                                                    <input type="checkbox" id="test-{{ category.id }}" name="test[]" data-datalayer-name="testFilter"
                                                            value="{{ category.id }}"/>
                                                    <label for="test-{{ category.id }}">{{ category.title }}</label>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                        <hr>
                                        <ul>
                                            {% for category in categories %}
                                                <li class="form__custom-checkbox">
                                                    <input type="checkbox" id="ignore-{{ category.id }}" name="ignore[]"
                                                            value="{{ category.id }}"/>
                                                    <label for="ignore-{{ category.id }}">{{ category.title }}</label>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                        <hr>
                                        <div>
                                            <input type="checkbox" id="ignore-me-too" name="ignore-me-too"
                                                            value="1"/>
                                                    <label for="ignore-me-too">Ignore me too</label>
                                        </div>
                                    </div>
                                {% endif %}
                                <button type="submit" class="sr-only">Submit</button>
                                <div>
                                    <button type="button" id="filterClear" data-always-show="true" data-inactive-class="opacity-50">Clear filter</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="w-full px-4 md:w-2/3">
                    <div id="filterScrollPosition">
                        <div class="hidden" tabindex="-1" id="filterLoader">
                            <div class="flex justify-center">
                                {% include '_site/_snippet/_item/_loader' %}
                            </div>
                        </div>
                        <div aria-live="polite" class="sr-only" id="filterAriaLive" tabindex="-1">
                            <span>{{ "A total of {total} items found."|t({total: totalEntries}) }}</span>
                            {% if pageInfo.totalPages > 1 %}
                                <span>{{ "Showing {totalItems} items on page {currentPage} of {totalPages}."|t({totalItems: totalEntries, currentPage: pageInfo.currentPage, totalPages: pageInfo.totalPages}) }}</span>
                            {% endif %}
                        </div>
                        <div id="filterResults">
                            {% if searchQuery or catQuery %}
                                <div class="flex flex-wrap">
                                    <span class="mr-4">{{ "Resultaten gefilterd op:"|t }}</span>
                                    {% if searchQuery %}
                                        <span class="flex items-center px-2 mb-2 mr-2 text-sm font-light text-white capitalize rounded-full bg-primary">{{ searchQuery }}
                                            <button type="button" class="flex items-center justify-center w-4 h-4 ml-2 text-black" data-filter-clear-elements='[{"name": "search"}]'>
                                                {{ icon('clear') }}
                                                <span class="sr-only">{{ "Verwijder filter "|t }} {{ searchQuery }}</span>
                                            </button>
                                        </span>
                                    {% endif %}
                                    {% if catQuery %}
                                        {% for category in categories.id(catQuery).all() %}
                                            <span class="flex items-center px-2 mb-2 mr-2 text-sm font-light text-white capitalize rounded-full bg-primary">{{ category.title }}
                                                <button type="button" class="flex items-center justify-center w-4 h-4 ml-2 text-black ie-hidden" data-filter-clear-elements='[{"name": "category[]","value": "{{ category.id }}"}]'>
                                                    {{ icon('clear') }}
                                                    <span class="sr-only">{{ "Verwijder filter "|t }} {{ category.title }}</span>
                                                </button>
                                            </span>
                                        {% endfor %}
                                    {% endif %}
                                    <button type="button" id="filterClearInResults">Clear filter</button>
                                </div>
                            {% endif %}
                            <div class="grid grid-cols-1 gap-5 sm:grid-cols-2">
                                {% for cardEntry in news %}
                                    {% include '_site/_snippet/_item/_card' %}
                                {% else %}
                                    <div class="sm:col-span-2 md:col-span-3">
                                        {{ "Geen items gevonden"|t }}
                                    </div>
                                {% endfor %}
                            </div>
                            {% if pageInfo.totalPages > 1 %}
                                <div id="filterPagination">
                                    {{ render_pagination(pageInfo, {
                                        pageRange: 2,
                                    }) | raw }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
