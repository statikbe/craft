{% extends "_site/_layout" %}

{% set breadcrumbs = [
    {
        url: './overview.twig',
        title: 'Plugins'
    },
    {
        url: './filter.twig',
        title: 'Filter'
    },
] %}

{% macro printMultiLevelCategory(category, catQuery) %}
    <li>
        <div class="flex items-center form__custom-checkbox">
            <input class="mr-2" type="checkbox" id="{{ category.id }}" name="category[]"
                   value="{{ category.id }}" {% if category.id in catQuery %} checked {% endif %}/>
            <label for="{{ category.id }}">{{ category.title }}</label>
            {% if category.children|length %}
                <button type="button" class="ml-auto cursor-pointer ie-hidden js-indeterminate-toggle">
                    {{ icon('chevron-down') }}
                    <span class="sr-only">{{ 'Options'|t }}
                        {{ category.title }}</span>
                </button>
            {% endif %}
        </div>
        {% if category.children|length %}
            <ul class="pl-4 js-indeterminate-sub-list">
                {% for child in category.children.all() %}
                    {{ _self.printMultiLevelCategory(child, catQuery) }}
                {% endfor %}
            </ul>
        {% endif %}
    </li>
{% endmacro %}

{% block content %}

    {% set entries = craft.entries.section('news') %}
    {% set relationParam = ['and'] %}

    {% set searchQuery = craft.app.request.getParam('search') %}
    {% set searchQuery = searchQuery is valid_query ? searchQuery : '' %}
    {% set catQuery = craft.app.request.getParam('category') %}
    {% set catQuery = catQuery is valid_id ? catQuery : [ ] %}

    {% if catQuery %}
        {% set relationParam = relationParam|merge([{ targetElement: catQuery }]) %}
    {% endif %}

    {% if relationParam|length > 1 %}
        {% set entries = entries.relatedTo(relationParam) %}
    {% endif %}

    {% if searchQuery %}
        {% set entries = entries.search(searchQuery).orderBy('score') %}
    {% endif %}

    {% set totalEntries = entries|length %}

    {% paginate entries.limit(2) as pageInfo, newsEntries %}

    <div class="section section--default">
        <div class="container">
            {% include '_site/_snippet/_nav/_breadcrumb' %}
            <div class="w-3/4">
                <h1>Filter plugin Example</h1>
                <p>This is an example on how to use the filter plugin.</p>
                <h2 id="filterExtraInfo">
                    {{ totalEntries }} {{ 'resultaten gevonden'|t }}
                </h2>
                <div id="secondExtraInfo">
                    {{ totalEntries }} {{ 'resultaten gevonden'|t }}
                </div>
            </div>
        </div>
    </div>

    <div class="section section--default">
        <div class="container">
            <div class="flex -mx-4">
                <div class="w-full px-4 md:w-1/3">
                    <div>
                        <div class="md:hidden">
                            <button type="button" id="filterMobileToggle">
                                {# This element will get the class 'open' when the filter is open #}
                                {{ 'Filter results'|t }}
                                {{ icon('chevron-down') }}
                            </button>
                        </div>
                        <div id="filterMobileCollapse">
                            <form action="" 
                                data-filter="filterResults" 
                                data-filter-extra="filterExtraInfo,secondExtraInfo" 
                                data-filter-mobile-toggle="filterMobileToggle"
                                data-filter-mobile-collapse="filterMobileCollapse" 
                                data-filter-scroll-position="filterScrollPosition" 
                                data-filter-loader="filterLoader" 
                                data-filter-aria-live="filterAriaLive" 
                                data-filter-pagination="filterPagination" 
                                data-filter-clear="filterClear,filterClearInResults" 
                                data-filter-scroll-on-new-results="true"
                                data-filter-disable-scroll-on-mobile="true"
                                data-filter-mobile-breakpoint="819"
                                data-filter-scroll-speed="500">
                                {% set categories = craft.entries.section('newsCategories').level(1) %}
                                {% if categories|length %}
                                    <div>
                                        <h4>{{ "Categories"|t }}</h4>
                                        <ul>
                                            {% for category in categories %}
                                                <li class="form__custom-checkbox">
                                                    <input type="checkbox" id="{{ category.id }}" name="category[]"
                                                           value="{{ category.id }}" {% if category.id in catQuery %} checked {% endif %}/>
                                                    <label for="{{ category.id }}">{{ category.title }}</label>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                {% endif %}
                                <button type="submit" class="mt-8 btn">Submit</button>
                            </form>
                            <div>
                                <button type="button" id="filterClear" data-s-always-show="true" data-inactive-class="opacity-50">Clear filter</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="w-full px-4 md:w-2/3">
                    <div id="filterScrollPosition">
                        <div class="hidden" tabindex="-1" id="filterLoader">
                            {% include '_site/_snippet/_item/_loader' %}
                        </div>
                        <div aria-live="polite" class="sr-only" id="filterAriaLive" tabindex="-1">
                            <span>{{ "A total of {total} items found."|t({total: totalEntries}) }}</span>
                            {% if pageInfo.totalPages > 1 %}
                                <span>{{ "Showing {totalItems} items on page {currentPage} of {totalPages}."|t({totalItems: totalEntries, currentPage: pageInfo.currentPage, totalPages: pageInfo.totalPages}) }}</span>
                            {% endif %}
                        </div>
                        <div id="filterResults">

                            {% if searchQuery or catQuery %}
                                <div class="flex flex-wrap">
                                    <span class="mr-4">{{ "Resultaten gefilterd op:"|t }}</span>
                                    {% if searchQuery %}
                                        <span class="flex items-center px-2 mb-2 mr-2 text-sm font-light text-white capitalize rounded-full bg-primary">{{ searchQuery }}
                                            <button type="button" class="flex items-center justify-center w-4 h-4 ml-2 text-black" data-filter-clear-elements='[{"name": "search"}]'>
                                                {{ icon('clear') }}
                                                <span class="sr-only">{{ "Verwijder filter "|t }} {{ searchQuery }}</span>
                                            </button>
                                        </span>
                                    {% endif %}
                                    {% if catQuery %}
                                        {% for category in categories.id(catQuery).all() %}
                                            <span class="flex items-center px-2 mb-2 mr-2 text-sm font-light text-white capitalize rounded-full bg-primary">{{ category.title }}
                                                <button type="button" class="flex items-center justify-center w-4 h-4 ml-2 text-black ie-hidden" data-filter-clear-elements='[{"name": "category[]","value": "{{ category.id }}"}]'>
                                                    {{ icon('clear') }}
                                                    <span class="sr-only">{{ "Verwijder filter "|t }} {{ category.title }}</span>
                                                </button>
                                            </span>
                                        {% endfor %}
                                    {% endif %}
                                    <button type="button" id="filterClearInResults" {# data-s-always-show="true" #}>Clear filter</button>
                                </div>
                            {% endif %}

                            <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 md:grid-cols-3">
                                {% for cardEntry in newsEntries %}
                                    {% include '_site/_snippet/_item/_card' with {amount: 2} %}
                                {% else %}
                                    <div>
                                        {{ "Geen items gevonden"|t }}
                                    </div>
                                {% endfor %}
                            </div>
                            {% if pageInfo.totalPages > 1 %}
                                <div id="filterPagination">
                                    {{ render_pagination(pageInfo, {
                                        pageRange: 2,
                                        prevText: '«',
                                        nextText: '»'
                                    }) | raw }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="section section--default">
        <div class="container">
            <div class="flex -mx-4">
                <div class="w-full px-4 md:w-1/3">
                    <form action="" 
                        data-filter="filterResultsMinimal"
                        data-filter-aria-live="filterAriaLiveMinimal">
                        {% set categories = craft.entries.section('newsCategories').level(1) %}
                        {% if categories|length %}
                            <div>
                                <h4>{{ "Categories"|t }}</h4>
                                <ul>
                                    {% for category in categories %}
                                        <li class="form__custom-checkbox">
                                            <input type="checkbox" id="{{ category.id }}minimal" name="category[]"
                                                    value="{{ category.id }}" {% if category.id in catQuery %} checked {% endif %}/>
                                            <label for="{{ category.id }}minimal">{{ category.title }}</label>
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        {% endif %}
                        <button type="submit" class="sr-only">Submit</button>
                    </form>
                    <div>
                        <button type="button" id="filterClear" data-s-always-show="true" data-inactive-class="opacity-50">Clear filter</button>
                    </div>
                </div>
                <div class="w-full px-4 md:w-2/3">
                    <div aria-live="polite" class="sr-only" id="filterAriaLiveMinimal" tabindex="-1">
                        <span>{{ "A total of {total} items found."|t({total: totalEntries}) }}</span>
                        {% if pageInfo.totalPages > 1 %}
                            <span>{{ "Showing {totalItems} items on page {currentPage} of {totalPages}."|t({totalItems: totalEntries, currentPage: pageInfo.currentPage, totalPages: pageInfo.totalPages}) }}</span>
                        {% endif %}
                    </div>
                    <div id="filterResultsMinimal">
                        <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 md:grid-cols-3">
                            {% for cardEntry in newsEntries %}
                                {% include '_site/_snippet/_item/_card' with {amount: 2} %}
                            {% else %}
                                <div class="sm:col-span-2 md:col-span-3">
                                    {{ "Geen items gevonden"|t }}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}
